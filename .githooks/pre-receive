#!/bin/bash
# Server-side hook that validates verification token
# This runs on the server and CANNOT be bypassed with --no-verify

# Read all refs being pushed
while read oldrev newrev refname; do
    # Get the commit message
    COMMIT_MSG=$(git log -1 --format=%B $newrev)

    # Check if verification token exists
    if ! echo "$COMMIT_MSG" | grep -q "Hook-Verification-Token:"; then
        echo "=========================================="
        echo "ERROR: Commit verification token missing!"
        echo "=========================================="
        echo ""
        echo "This commit was not processed by pre-commit hooks."
        echo ""
        echo "Possible causes:"
        echo "  1. You used 'git commit --no-verify'"
        echo "  2. Git hooks are not configured (run: git config core.hooksPath .githooks)"
        echo "  3. Pre-commit hook was deleted or disabled"
        echo ""
        echo "Action required:"
        echo "  - Do NOT use --no-verify flag"
        echo "  - Ensure hooks are enabled: git config core.hooksPath .githooks"
        echo "  - Re-commit without --no-verify"
        echo ""
        echo "=========================================="
        exit 1
    fi

    # Extract token from commit message
    TOKEN=$(echo "$COMMIT_MSG" | grep "Hook-Verification-Token:" | cut -d' ' -f2)

    # Validate token format (should be 64 char hex from sha256)
    if ! echo "$TOKEN" | grep -qE '^[a-f0-9]{64}$'; then
        echo "=========================================="
        echo "ERROR: Invalid verification token format!"
        echo "=========================================="
        echo ""
        echo "Token appears to be manually added or corrupted."
        echo "Token must be generated by pre-commit hook."
        echo ""
        echo "=========================================="
        exit 1
    fi

    echo "âœ“ Commit verification token validated: ${TOKEN:0:16}..."
done

exit 0
